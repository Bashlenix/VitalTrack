{% extends "main/base.html" %}

{% block title %}Edit Lab Result{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/lab/edit_lab_result.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'error' if category == 'error' else category }}">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="header">
        <h1>Edit Lab Result</h1>
        <!-- <div class="header-actions">
            <a href="{{ url_for('lab_results.view_lab_results') }}" class="btn btn-secondary">Back to Lab Results</a>
        </div> -->
    </div>

    <!-- Patient Information -->
    <div class="patient-info">
        <h3>Patient: {{ lab_result.patient.first_name }} {{ lab_result.patient.last_name }}</h3>
        <p><strong>Date of Birth:</strong> {{ lab_result.patient.date_of_birth.strftime('%Y-%m-%d') if
            lab_result.patient.date_of_birth else 'Not specified' }}</p>
        <p><strong>Age:</strong> {{ (2025 - lab_result.patient.date_of_birth.year) if lab_result.patient.date_of_birth
            else 'Unknown' }} years old</p>
    </div>

    <!-- Edit Form -->
    <div class="form-container">
        <form method="POST">
            <div class="form-row">
                <div class="form-group autocomplete">
                    <label for="test_name">Test Name <span class="required">*</span></label>
                    <input type="text" id="test_name" name="test_name" value="{{ lab_result.test_name }}" required
                        placeholder="e.g., Blood Glucose, Complete Blood Count">
                </div>
                <div class="form-group">
                    <label for="test_date">Test Date <span class="required">*</span></label>
                    <input type="datetime-local" id="test_date" name="test_date"
                        value="{{ lab_result.date.strftime('%Y-%m-%dT%H:%M') }}" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="result">Test Result <span class="required">*</span></label>
                    <input type="text" id="result" name="result" required
                        placeholder="Enter the test result, e.g., 12.5, Normal, Positive"
                        value="{{ lab_result.result }}">
                </div>

                <div class="form-group">
                    <label for="unit">Unit</label>
                    <input type="text" id="unit" name="unit" placeholder="Enter the unit, e.g., mg/dL, %"
                        value="{{ lab_result.unit if lab_result.unit else '' }}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="reference_range">Reference Range</label>
                    <input type="text" id="reference_range" name="reference_range"
                        placeholder="Enter the reference range, e.g., 4.0-6.0, Normal"
                        value="{{ lab_result.reference_range if lab_result.reference_range else '' }}">
                </div>

                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="">Select status</option>
                        <option value="normal" {{ 'selected' if lab_result.status.value=='normal' }}>Normal</option>
                        <option value="abnormal" {{ 'selected' if lab_result.status.value=='abnormal' }}>Abnormal
                        </option>
                        <option value="high" {{ 'selected' if lab_result.status.value=='high' }}>High</option>
                        <option value="low" {{ 'selected' if lab_result.status.value=='low' }}>Low</option>
                        <option value="critical" {{ 'selected' if lab_result.status.value=='critical' }}>Critical
                        </option>
                        <option value="pending" {{ 'selected' if lab_result.status.value=='pending' }}>Pending</option>
                    </select>
                </div>

            </div>
            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes"
                    placeholder="Additional notes about the test results, interpretation, or follow-up recommendations">{{ lab_result.notes if lab_result.notes else '' }}</textarea>
            </div>
            <div class="button-group">
                <button type="submit" class="btn btn-success">Update Lab Result</button>
                <a href="{{ url_for('lab_results.view_lab_results') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Common test name suggestions
    const commonTests = [
        'Complete Blood Count (CBC)',
        'Comprehensive Metabolic Panel (CMP)',
        'Lipid Panel',
        'Hemoglobin A1c (HbA1c)',
        'Thyroid Stimulating Hormone (TSH)',
        'Prostate Specific Antigen (PSA)',
        'Urinalysis',
        'Vitamin D',
        'Vitamin B12',
        'Folate',
        'Iron Studies',
        'Liver Function Tests (LFT)',
        'Kidney Function Tests',
        'Cardiac Enzymes',
        'Blood Glucose',
        'C-Reactive Protein (CRP)',
        'Erythrocyte Sedimentation Rate (ESR)',
        'Troponin',
        'BUN/Creatinine',
        'Electrolytes',
        'Magnesium',
        'Phosphorus',
        'Calcium',
        'Albumin',
        'Total Protein',
        'Bilirubin'
    ];

    // Autocomplete functionality
    function autocomplete(inp, arr) {
        var currentFocus;

        inp.addEventListener("input", function (e) {
            var a, b, i, val = this.value;
            closeAllLists();
            if (!val) { return false; }
            currentFocus = -1;

            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);

            for (i = 0; i < arr.length; i++) {
                if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                    b = document.createElement("DIV");
                    b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                    b.innerHTML += arr[i].substr(val.length);
                    b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";

                    b.addEventListener("click", function (e) {
                        inp.value = this.getElementsByTagName("input")[0].value;
                        closeAllLists();
                    });
                    a.appendChild(b);
                }
            }
        });

        inp.addEventListener("keydown", function (e) {
            var x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) {
                currentFocus++;
                addActive(x);
            } else if (e.keyCode == 38) {
                currentFocus--;
                addActive(x);
            } else if (e.keyCode == 13) {
                e.preventDefault();
                if (currentFocus > -1) {
                    if (x) x[currentFocus].click();
                }
            }
        });

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("autocomplete-active");
        }

        function removeActive(x) {
            for (var i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }

        function closeAllLists(elmnt) {
            var x = document.getElementsByClassName("autocomplete-items");
            for (var i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != inp) {
                    x[i].parentNode.removeChild(x[i]);
                }
            }
        }

        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });
    }

    // Initialize autocomplete for test name field
    autocomplete(document.getElementById("test_name"), commonTests);

    // Set maximum test_date to today (including current time)
    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000;
    const localISOTime = new Date(now - offset).toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM
    document.getElementById('test_date').max = localISOTime;

    // Form validation
    document.querySelector('form').addEventListener('submit', function (e) {
        const testName = document.getElementById('test_name').value.trim();
        const result = document.getElementById('result').value.trim();
        const testDate = document.getElementById('test_date').value;

        if (!testName || !result || !testDate) {
            e.preventDefault();
            alert('Please fill in all required fields.');
            return false;
        }

        return true;
    });

    // Auto-hide flash messages after 5 seconds
    setTimeout(() => {
        const flashMessages = document.querySelectorAll('.alert');
        flashMessages.forEach(msg => {
            msg.style.transition = 'opacity 0.5s';
            msg.style.opacity = '0';
            setTimeout(() => msg.remove(), 500);
        });
    }, 5000);
</script>
{% endblock %}