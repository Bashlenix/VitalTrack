<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Lab Result - EHR System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/lab/add_lab_result.css') }}">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Add Lab Result</h1>
            <p>Record new laboratory test results</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ 'error' if category == 'error' else category }}">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="lab-info">
            <h4>Common Lab Tests</h4>
            <ul>
                <li><strong>CBC:</strong> Complete Blood Count</li>
                <li><strong>CMP:</strong> Comprehensive Metabolic Panel</li>
                <li><strong>Lipid Panel:</strong> Cholesterol and triglycerides</li>
                <li><strong>HbA1c:</strong> Blood sugar control (diabetes)</li>
                <li><strong>TSH:</strong> Thyroid function</li>
                <li><strong>PSA:</strong> Prostate specific antigen</li>
            </ul>
        </div>

        <form method="POST" id="labResultForm">
            <div class="form-group">
                <label for="patient_id">Patient <span class="required">*</span></label>
                <select id="patient_id" name="patient_id" required>
                    <option value="">Select a patient</option>
                    {% for patient in patients %}
                    <option value="{{ patient.id }}"
                        data-dob="{{ patient.date_of_birth.strftime('%Y-%m-%d') if patient.date_of_birth }}"
                        {{ 'selected' if (request.form.patient_id==patient.id|string) or
                        (selected_patient_id==patient.id|string) }}>
                        {{ patient.first_name }} {{ patient.last_name }}
                        {% if patient.date_of_birth %}
                        (DOB: {{ patient.date_of_birth.strftime('%Y-%m-%d') }})
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-row">
                <div class="form-group autocomplete">
                    <label for="test_name">Test Name <span class="required">*</span></label>
                    <input type="text" id="test_name" name="test_name" required
                        placeholder="e.g., Complete Blood Count (CBC)"
                        value="{{ request.form.test_name if request.form.test_name }}">
                </div>

                <div class="form-group">
                    <label for="test_date">Test Date <span class="required">*</span></label>
                    <input type="datetime-local" id="test_date" name="test_date" required
                        value="{{ request.form.test_date if request.form.test_date }}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="result_value">Result Value<span class="required">*</span></label>
                    <input type="text" id="result_value" name="result" required
                        placeholder="e.g., 12.5, Normal, Positive"
                        value="{{ request.form.result if request.form.result }}">
                </div>

                <div class="form-group">
                    <label for="unit">Unit</label>
                    <input type="text" id="unit" name="unit" placeholder="e.g., mg/dL, g/dL, %"
                        value="{{ request.form.unit if request.form.unit }}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="reference_range">Reference Range</label>
                    <input type="text" id="reference_range" name="reference_range"
                        placeholder="e.g., 10-15, <100, Normal"
                        value="{{ request.form.reference_range if request.form.reference_range }}">
                </div>

                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="">Select status</option>
                        <option value="Normal" {{ 'selected' if request.form.status=='Normal' }}>Normal</option>
                        <option value="Abnormal" {{ 'selected' if request.form.status=='Abnormal' }}>Abnormal</option>
                        <option value="High" {{ 'selected' if request.form.status=='High' }}>High</option>
                        <option value="Low" {{ 'selected' if request.form.status=='Low' }}>Low</option>
                        <option value="Critical" {{ 'selected' if request.form.status=='Critical' }}>Critical</option>
                        <option value="Pending" {{ 'selected' if request.form.status=='Pending' }}>Pending</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes"
                    placeholder="Additional notes about the test results, interpretation, or follow-up recommendations">{{ request.form.notes if request.form.notes }}</textarea>
            </div>

            <div class="button-group">
                <button type="submit" class="btn btn-primary">Add Lab Result</button>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>

    <script>
        // Set maximum test_date to now (including current time)
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        const localISOTime = new Date(now - offset).toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM
        document.getElementById('test_date').max = localISOTime;

        // Form validation
        document.querySelector('form').addEventListener('submit', function (e) {
            const testName = document.getElementById('test_name').value.trim();
            const result = document.getElementById('result').value.trim();
            const testDate = document.getElementById('test_date').value;

            if (!testName || !result || !testDate) {
                e.preventDefault();
                alert('Please fill in all required fields.');
                return false;
            }

            return true;
        });

        // Common test name suggestions
        const commonTests = [
            'Complete Blood Count (CBC)',
            'Comprehensive Metabolic Panel (CMP)',
            'Lipid Panel',
            'Hemoglobin A1c (HbA1c)',
            'Thyroid Stimulating Hormone (TSH)',
            'Prostate Specific Antigen (PSA)',
            'Urinalysis',
            'Vitamin D',
            'Vitamin B12',
            'Folate',
            'Iron Studies',
            'Liver Function Tests (LFT)',
            'Kidney Function Tests',
            'Cardiac Enzymes',
            'Blood Glucose',
            'C-Reactive Protein (CRP)',
            'Erythrocyte Sedimentation Rate (ESR)',
            'Troponin',
            'BUN/Creatinine',
            'Electrolytes',
            'Magnesium',
            'Phosphorus',
            'Calcium',
            'Albumin',
            'Total Protein',
            'Bilirubin'
        ];

        // autocomplete functionality
        function autocomplete(inp, arr) {
            /*the autocomplete function takes two arguments,
            the text field element and an array of possible autocompleted values:*/
            var currentFocus;
            /*execute a function when someone writes in the text field:*/
            inp.addEventListener("input", function (e) {
                var a, b, i, val = this.value;
                /*close any already open lists of autocompleted values*/
                closeAllLists();
                if (!val) { return false; }
                currentFocus = -1;
                /*create a DIV element that will contain the items (values):*/
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                /*append the DIV element as a child of the autocomplete container:*/
                this.parentNode.appendChild(a);
                /*for each item in the array...*/
                for (i = 0; i < arr.length; i++) {
                    /*check if the item starts with the same letters as the text field value:*/
                    if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                        /*create a DIV element for each matching element:*/
                        b = document.createElement("DIV");
                        /*make the matching letters bold:*/
                        b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                        b.innerHTML += arr[i].substr(val.length);
                        /*insert a input field that will hold the current array item's value:*/
                        b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                        /*execute a function when someone clicks on the item value (DIV element):*/
                        b.addEventListener("click", function (e) {
                            /*insert the value for the autocomplete text field:*/
                            inp.value = this.getElementsByTagName("input")[0].value;
                            /*close the list of autocompleted values,
                            (or any other open lists of autocompleted values:*/
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });
            /*execute a function presses a key on the keyboard:*/
            inp.addEventListener("keydown", function (e) {
                var x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) {
                    /*If the arrow DOWN key is pressed,
                    increase the currentFocus variable:*/
                    currentFocus++;
                    /*and and make the current item more visible:*/
                    addActive(x);
                } else if (e.keyCode == 38) { //up
                    /*If the arrow UP key is pressed,
                    decrease the currentFocus variable:*/
                    currentFocus--;
                    /*and and make the current item more visible:*/
                    addActive(x);
                } else if (e.keyCode == 13) {
                    /*If the ENTER key is pressed, prevent the form from being submitted,*/
                    e.preventDefault();
                    if (currentFocus > -1) {
                        /*and simulate a click on the "active" item:*/
                        if (x) x[currentFocus].click();
                    }
                }
            });
            function addActive(x) {
                /*a function to classify an item as "active":*/
                if (!x) return false;
                /*start by removing the "active" class on all items:*/
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                /*add class "autocomplete-active":*/
                x[currentFocus].classList.add("autocomplete-active");
            }
            function removeActive(x) {
                /*a function to remove the "active" class from all autocomplete items:*/
                for (var i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }
            function closeAllLists(elmnt) {
                /*close all autocomplete lists in the document,
                except the one passed as an argument:*/
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            /*execute a function when someone clicks in the document:*/
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }
        autocomplete(document.getElementById("test_name"), commonTests);


        // Trigger patient info display if form is pre-filled
        if (document.getElementById('patient_id').value) {
            document.getElementById('patient_id').dispatchEvent(new Event('change'));
        }
    </script>
</body>

</html>