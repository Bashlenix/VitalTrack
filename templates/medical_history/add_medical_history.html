{% extends "main/base.html" %}

{% block title %}Add Medical History{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/medical_history/forms.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="medical-form-container">
        <div class="form-header">
            <h1>Add Medical History</h1>
            <p>Record medical history and allergy information</p>
        </div>

        <form method="POST" id="medicalHistoryForm">
            <div class="form-group">
                <label for="patient_id">Patient <span class="required">*</span></label>
                <select id="patient_id" name="patient_id" class="form-control" required>
                    <option value="">Select a patient</option>
                    {% for patient in patients %}
                    <option value="{{ patient.id }}"
                        data-dob="{{ patient.date_of_birth.strftime('%Y-%m-%d') if patient.date_of_birth }}"
                        {{ 'selected' if (request.form.patient_id==patient.id|string) or
                        (selected_patient_id==patient.id|string) }}>
                        {{ patient.first_name }} {{ patient.last_name }}
                        {% if patient.date_of_birth %}
                        (DOB: {{ patient.date_of_birth.strftime('%Y-%m-%d') }})
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-row">
                <div class="form-group autocomplete">
                    <label for="allergy_name">Allergy/Condition <span class="required">*</span></label>
                    <input type="text" id="allergy_name" name="allergy_name" class="form-control" required
                        placeholder="Type to search or enter new allergy/condition..." autocomplete="off"
                        value="{{ request.form.allergy_name if request.form.allergy_name }}">
                </div>

                <div class="form-group">
                    <label for="history_date">Date <span class="required">*</span></label>
                    <input type="date" id="history_date" name="history_date" class="form-control" required
                        value="{{ request.form.history_date if request.form.history_date }}">
                </div>
            </div>

            <div id="allergyInfo" class="allergy-info" style="display: none;">
                <h4>Allergy Information</h4>
                <p id="allergyDescription"></p>
            </div>

            <div class="form-group">
                <label for="description">Description <span class="required">*</span></label>
                <textarea id="description" name="description" class="form-control" required
                    placeholder="Describe the medical history, severity, symptoms, treatment, or any relevant details">{{ request.form.description if request.form.description }}</textarea>
            </div>

            <div class="btn-group-custom">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Add Medical History
                </button>
                <a href="{{ url_for('patients.view_all_patients') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Database allergies for autocomplete - populated from server
    const databaseAllergies = [
        {% for allergy in allergies %}
    "{{ allergy.name }}"{ { ',' if not loop.last else '' } }
    {% endfor %}
    ];

    // Autocomplete function for allergy/condition field
    function setupAllergyAutocomplete(input, allergyData) {
        let currentFocus;

        input.addEventListener('input', function (e) {
            let a, b, i, val = this.value;
            closeAllLists();
            if (!val) { return false; }
            currentFocus = -1;

            a = document.createElement('DIV');
            a.setAttribute('id', this.id + 'autocomplete-list');
            a.setAttribute('class', 'autocomplete-items');
            this.parentNode.appendChild(a);

            let hasMatches = false;
            for (i = 0; i < allergyData.length; i++) {
                if (allergyData[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                    hasMatches = true;
                    b = document.createElement('DIV');
                    b.innerHTML = '<strong>' + allergyData[i].substr(0, val.length) + '</strong>';
                    b.innerHTML += allergyData[i].substr(val.length);
                    b.innerHTML += '<input type="hidden" value="' + allergyData[i] + '">';

                    b.addEventListener('click', function (e) {
                        input.value = this.getElementsByTagName('input')[0].value;
                        closeAllLists();
                    });
                    a.appendChild(b);
                }
            }
        });

        input.addEventListener('keydown', function (e) {
            let x = document.getElementById(this.id + 'autocomplete-list');
            if (x) x = x.getElementsByTagName('div');
            if (e.keyCode == 40) {
                currentFocus++;
                addActive(x);
            } else if (e.keyCode == 38) {
                currentFocus--;
                addActive(x);
            } else if (e.keyCode == 13) {
                e.preventDefault();
                if (currentFocus > -1) {
                    if (x) x[currentFocus].click();
                }
            }
        });

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add('autocomplete-active');
        }

        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove('autocomplete-active');
            }
        }

        function closeAllLists(elmnt) {
            let x = document.getElementsByClassName('autocomplete-items');
            for (let i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != input) {
                    x[i].parentNode.removeChild(x[i]);
                }
            }
        }

        document.addEventListener('click', function (e) {
            closeAllLists(e.target);
        });
    }

    // Initialize autocomplete for allergy field
    document.addEventListener('DOMContentLoaded', function () {
        const allergyInput = document.getElementById('allergy_name');

        // if (databaseAllergies.length === 0) {
        //     console.warn('No allergies found in database! Autocomplete will show no suggestions.');
        // }

        setupAllergyAutocomplete(allergyInput, databaseAllergies);
    });

    // Show allergy information when typing (simplified for text input)
    document.getElementById('allergy_name').addEventListener('input', function () {
        const input = this;
        const allergyInfo = document.getElementById('allergyInfo');
        const allergyDescription = document.getElementById('allergyDescription');

        if (input.value.trim()) {
            allergyDescription.textContent = 'You can enter a new allergy/condition or select from existing ones. If this is a new entry, it will be added to the system.';
            allergyInfo.style.display = 'block';
        } else {
            allergyInfo.style.display = 'none';
        }
    });

    // Set maximum date to today (can't have future medical history by default)
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('history_date').max = today;

    document.getElementById('medicalHistoryForm').addEventListener('submit', function (e) {
        const patientId = document.getElementById('patient_id').value;
        const allergyName = document.getElementById('allergy_name').value.trim();
        const description = document.getElementById('description').value.trim();
        const historyDate = document.getElementById('history_date').value;

        if (!patientId || !allergyName || !description || !historyDate) {
            e.preventDefault();
            alert('Please fill in all required fields.');
            return false;
        }

        // Validate date is not in the future
        const selectedDate = new Date(historyDate);
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0); // Reset time to compare dates only

        if (selectedDate > todayDate) {
            e.preventDefault();
            alert('Medical history date cannot be in the future.');
            return false;
        }

        return true;
    });

    // Trigger info displays if form is pre-filled
    if (document.getElementById('patient_id').value) {
        document.getElementById('patient_id').dispatchEvent(new Event('change'));
    }
    if (document.getElementById('allergy_name').value) {
        document.getElementById('allergy_name').dispatchEvent(new Event('input'));
    }
</script>
{% endblock %}